name: Deploy to AWS Lightsail

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy to Lightsail instance
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.LIGHTSAIL_SSH_HOST }} # IP da instância (do secret)
          username: ${{ secrets.LIGHTSAIL_SSH_USERNAME }} # Usuário (do secret)
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }} # Chave SSH privada (do secret)
          script: |
            cd ~/ai-image-dogs-classifier

            echo ">>> Pulling latest changes from GitHub..."
            git pull origin main

            echo ">>> Building Docker images..."
            docker-compose build

            echo ">>> Restarting services..."
            docker-compose up -d

            echo ">>> Pruning old Docker images..."
            docker image prune -f

            echo ">>> Deployment finished successfully! <<<"
